# FactorScores Bug Fix - September 29, 2025

## Issue Summary
The `/api/stocks/analyze` endpoint was returning factorScores of 0 for all categories (Technical, Fundamental, Macro, Sentiment, ESG, Analyst) when analyzing stocks like TSLA, despite the underlying analysis services calculating proper scores.

## Root Cause
The issue was a **naming mismatch** between the factor score keys generated by `AlgorithmEngine.ts` and the keys expected by the response conversion function in `/api/stocks/analyze/route.ts`.

### What Was Happening:
1. **AlgorithmEngine** (in `calculateCompositeComponents` method) generates factor scores with keys like:
   - `technical_overall_score` (0-1 scale)
   - `technicalScore` (0-100 scale)
   - `fundamentalScore` (0-100 scale)
   - `analystScore` (0-100 scale)
   - `sentiment_composite` (0-1 scale)
   - `macroeconomic_composite` (0-1 scale)
   - `esg_composite` (0-1 scale)

2. **convertToAdminResponse** function was looking for:
   - `technical_composite` (didn't exist)
   - `fundamental_composite` (didn't exist)
   - `analyst_composite` (didn't exist)

When these keys weren't found, the function defaulted all scores to 0.

## Solution
Updated the `convertToAdminResponse` function in `/app/api/stocks/analyze/route.ts` to:

1. **Use correct factor score key names** that match what AlgorithmEngine actually generates
2. **Add proper scale conversion** for factors that use 0-1 scale (converting to 0-100 for API response)
3. **Implement robust fallback chains** to handle multiple naming conventions

### Updated Extraction Logic:
```typescript
// Technical: technical_overall_score or technicalScore (0-100 scale)
const technicalScore = factorScores.technicalScore ||
                      (factorScores.technical_overall_score ? factorScores.technical_overall_score * 100 : 0) ||
                      factorScores.technical_composite ||
                      factorScores.technical || 0

// Fundamental: fundamentalScore (0-100 scale) or quality_composite/value_composite
const fundamentalScore = factorScores.fundamentalScore ||
                        factorScores.fundamental_composite ||
                        factorScores.fundamental ||
                        factorScores.fundamentalData || 0

// Macroeconomic: macroeconomic_composite (0-1 scale, convert to 0-100)
const macroeconomicScore = (factorScores.macroeconomic_composite ? factorScores.macroeconomic_composite * 100 : 0) ||
                          factorScores.macroeconomic || 0

// Sentiment: sentiment_composite (0-1 scale, convert to 0-100)
const sentimentScore = (factorScores.sentiment_composite ? factorScores.sentiment_composite * 100 : 0) ||
                      factorScores.sentiment || 0

// ESG: esg_composite (0-1 scale, convert to 0-100)
const esgScore = (factorScores.esg_composite ? factorScores.esg_composite * 100 : 0) ||
                factorScores.esg || 0

// Analyst: analystScore (0-100 scale)
const analystScore = factorScores.analystScore ||
                    factorScores.analyst_composite ||
                    factorScores.analyst ||
                    factorScores.analysts || 0
```

## Testing Results

### Before Fix:
```json
{
  "symbol": "TSLA",
  "technicalScore": 0,
  "fundamentalScore": 0,
  "macroeconomicScore": 0,
  "sentimentScore": 0,
  "esgScore": 0,
  "analystScore": 0
}
```

### After Fix:
```json
{
  "symbol": "TSLA",
  "technicalScore": 46,
  "fundamentalScore": 50,
  "macroeconomicScore": 100,
  "sentimentScore": 60.4,
  "esgScore": 75,
  "analystScore": 38
}
```

### AAPL Test Results:
```json
{
  "symbol": "AAPL",
  "technicalScore": 48,
  "fundamentalScore": 40,
  "macroeconomicScore": 100,
  "sentimentScore": 54.9,
  "esgScore": 81,
  "analystScore": 38
}
```

## Impact
- ✅ All factor scores now properly displayed in API responses
- ✅ Admin dashboard can correctly show score breakdowns
- ✅ No data loss - all underlying calculations were already working
- ✅ Scale conversion ensures consistent 0-100 score presentation

## Files Modified
- `/app/api/stocks/analyze/route.ts` - Updated `convertToAdminResponse` function (lines 228-262)

## Prevention
To prevent this issue in the future:
1. **Document factor score naming conventions** in AlgorithmEngine
2. **Add TypeScript interfaces** for factor score objects with strict key names
3. **Create unit tests** that validate factor score extraction
4. **Add integration tests** that verify API response structure

## Related Code References
- **Factor Score Generation**: `/app/services/algorithms/AlgorithmEngine.ts` (lines 795-970)
- **Factor Score Type Definition**: `/app/services/algorithms/types.ts` (line 107)
- **API Response Conversion**: `/app/api/stocks/analyze/route.ts` (lines 228-293)

## Issue Recurrence Note
This was supposedly fixed recently but returned. This suggests the fix may have been:
1. Partially implemented
2. Reverted during a code merge
3. Fixed in a different endpoint but not this one

Going forward, ensure fixes are applied to all relevant endpoints.