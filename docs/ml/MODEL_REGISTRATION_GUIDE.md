# ML Model Registration Guide

**Last Updated:** 2025-10-10
**Audience:** ML Engineers, Backend Developers
**Prerequisites:** Understanding of LightGBM, PostgreSQL, TypeScript

## Overview

This guide explains how to properly register ML models in the VFR API system. Model registration is critical for the ensemble prediction system to discover and load your trained models.

---

## Table of Contents

1. [Model Directory Requirements](#model-directory-requirements)
2. [Database Registration](#database-registration)
3. [Registration Scripts](#registration-scripts)
4. [Verification Steps](#verification-steps)
5. [Common Issues](#common-issues)

---

## Model Directory Requirements

### Required Directory Structure

Every model MUST follow this exact structure:

```
models/
└── {model-name}/
    └── {version}/
        ├── model.txt              ← REQUIRED: LightGBM model file
        ├── normalizer.json        ← REQUIRED: Feature normalization params
        ├── metadata.json          ← REQUIRED: Model metadata
        ├── feature_importance.csv ← OPTIONAL: Feature rankings
        └── test_evaluation.json   ← OPTIONAL: Test metrics
```

### Naming Conventions

**model-name:** Must match database `model_name` field exactly
- Use kebab-case: `sentiment-fusion`, `price-prediction`, `early-signal`
- No spaces or special characters
- Must be unique across all models

**version:** Semantic versioning format
- Pattern: `v{major}.{minor}.{patch}`
- Examples: `v1.0.0`, `v1.1.0`, `v2.0.0-beta`
- Must match database `model_version` field

### Required Files

#### 1. model.txt

**Format:** LightGBM text format
**Size:** Typically 10-500MB
**Generated by:** `lgb.Booster.save_model('model.txt')`

**Example Training Code:**
```python
import lightgbm as lgb

# Train model
model = lgb.LGBMClassifier(
    objective='multiclass',
    num_classes=3,
    n_estimators=1000,
    learning_rate=0.01
)
model.fit(X_train, y_train)

# Save model
model.booster_.save_model('models/sentiment-fusion/v1.1.0/model.txt')
```

#### 2. normalizer.json

**Format:** JSON
**Purpose:** z-score normalization parameters (mean, std) for each feature

**Schema:**
```json
{
  "feature_name": {
    "mean": <float>,
    "std": <float>
  }
}
```

**Example:**
```json
{
  "sentiment_positive": {
    "mean": 0.2451,
    "std": 0.1872
  },
  "sentiment_negative": {
    "mean": 0.1324,
    "std": 0.0987
  },
  "price_momentum_5d": {
    "mean": 0.0089,
    "std": 0.0456
  }
}
```

**Generation Code:**
```python
import json
import numpy as np

# Calculate normalization params from training data
normalizer = {}
for col in X_train.columns:
    normalizer[col] = {
        "mean": float(X_train[col].mean()),
        "std": float(X_train[col].std())
    }

# Save to file
with open('models/sentiment-fusion/v1.1.0/normalizer.json', 'w') as f:
    json.dump(normalizer, f, indent=2)
```

#### 3. metadata.json

**Format:** JSON
**Purpose:** Model training metadata and performance metrics

**Required Fields:**
```json
{
  "model_version": "v1.1.0",
  "model_type": "sentiment-fusion",
  "algorithm": "LightGBM",
  "objective": "multiclass",
  "num_classes": 3,
  "classes": ["DOWN", "NEUTRAL", "UP"],
  "training_date": "2025-10-09T21:09:18.536489",
  "training_examples": 34846,
  "validation_examples": 7467,
  "num_features": 45,
  "performance": {
    "validation_accuracy": 0.5380,
    "best_iteration": 1000,
    "total_iterations": 1000
  }
}
```

**Optional Fields:**
```json
{
  "feature_categories": {
    "sentiment": 4,
    "price_technical": 41
  },
  "top_features": [
    {
      "feature": "volatility_20d",
      "importance": 5206
    }
  ],
  "hyperparameters": {
    "learning_rate": 0.01,
    "max_depth": 7,
    "num_leaves": 31
  }
}
```

---

## Database Registration

### Table Schema

Models are registered in the `ml_models` PostgreSQL table:

```sql
CREATE TABLE ml_models (
    model_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    model_name VARCHAR(255) NOT NULL,      -- e.g., "sentiment-fusion"
    model_version VARCHAR(50) NOT NULL,     -- e.g., "v1.1.0"
    model_type VARCHAR(100) NOT NULL,       -- e.g., "lightgbm"
    objective VARCHAR(100) NOT NULL,        -- e.g., "direction_classification"
    target_variable VARCHAR(255) NOT NULL,  -- e.g., "price_direction_3d"
    prediction_horizon VARCHAR(20) NOT NULL, -- e.g., "1w"

    -- Performance Metrics
    validation_score DECIMAL(10,6),
    test_score DECIMAL(10,6),

    -- Tier Management
    tier_requirement VARCHAR(20) DEFAULT 'premium',

    -- Deployment Status
    status VARCHAR(50) DEFAULT 'deployed',

    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),

    UNIQUE(model_name, model_version)
);
```

**IMPORTANT:** There is NO `artifact_path` column. Model paths are constructed dynamically using:
```
models/{model_name}/{model_version}/model.txt
```

### Manual SQL Registration

```sql
INSERT INTO ml_models (
    model_name,
    model_version,
    model_type,
    objective,
    target_variable,
    prediction_horizon,
    validation_score,
    test_score,
    tier_requirement,
    status
) VALUES (
    'sentiment-fusion',       -- Must match directory name
    'v1.1.0',                 -- Must match version directory
    'lightgbm',               -- Algorithm type
    'direction_classification', -- Prediction objective
    'price_direction_3d',     -- Target variable
    '1w',                     -- Prediction horizon (1 week)
    0.5380,                   -- Validation accuracy
    0.5250,                   -- Test accuracy
    'premium',                -- Required tier
    'deployed'                -- Deployment status
);
```

### Field Descriptions

**model_name:**
- Unique identifier for the model family
- Must match directory name exactly
- Examples: `sentiment-fusion`, `price-prediction`, `early-signal`

**model_version:**
- Semantic version string
- Must match version directory exactly
- Use `vX.Y.Z` format

**model_type:**
- Algorithm used: `lightgbm`, `xgboost`, `lstm`, `transformer`, `ensemble`

**objective:**
- `price_prediction` - Predict future price
- `direction_classification` - Predict UP/DOWN/NEUTRAL
- `volatility_forecast` - Predict volatility
- `factor_enhancement` - Enhance VFR factors

**target_variable:**
- What the model predicts
- Examples: `price_return_5d`, `price_direction_3d`, `analyst_rating_change`

**prediction_horizon:**
- Time horizon for predictions
- Values: `1h`, `4h`, `1d`, `1w`, `2w`, `1m`, `3m`

**status:**
- `training` - Model being trained
- `validated` - Training complete, not deployed
- `deployed` - Active in production (only deployed models are used)
- `shadow` - A/B testing (runs but doesn't contribute to decisions)
- `deprecated` - Old version, not in use

**tier_requirement:**
- `free` - Available to all users
- `premium` - Paid tier only
- `enterprise` - Enterprise customers only

---

## Registration Scripts

### TypeScript Registration (Recommended)

**Location:** `scripts/ml/register-{model-name}-model.ts`

**Example: sentiment-fusion registration**

```typescript
// scripts/ml/register-sentiment-fusion-model.ts
import {
  ModelRegistry,
  ModelType,
  ModelObjective,
  ModelStatus,
  TierRequirement
} from '../../app/services/ml/models/ModelRegistry';

async function registerSentimentFusionModel() {
  const registry = ModelRegistry.getInstance();
  await registry.initialize();

  console.log('Registering sentiment-fusion v1.1.0...');

  const result = await registry.registerModel({
    modelName: 'sentiment-fusion',
    modelVersion: 'v1.1.0',
    modelType: ModelType.LIGHTGBM,
    objective: ModelObjective.DIRECTION_CLASSIFICATION,
    targetVariable: 'price_direction_3d',
    predictionHorizon: '1w',
    validationScore: 0.5380,
    testScore: 0.5250,
    tierRequirement: TierRequirement.PREMIUM,
    status: ModelStatus.DEPLOYED
  });

  if (result.success && result.data) {
    console.log('✅ Model registered successfully');
    console.log('   Model ID:', result.data.modelId);
    console.log('   Model Name:', result.data.modelName);
    console.log('   Model Version:', result.data.modelVersion);
    console.log('   Status:', result.data.status);
    console.log('   Validation Score:', result.data.validationScore);
  } else {
    console.error('❌ Registration failed:', result.error?.message);
    process.exit(1);
  }
}

// Run registration
registerSentimentFusionModel()
  .then(() => {
    console.log('Registration complete');
    process.exit(0);
  })
  .catch(error => {
    console.error('Registration error:', error);
    process.exit(1);
  });
```

**Run registration:**
```bash
npx ts-node scripts/ml/register-sentiment-fusion-model.ts
```

### Python Registration Alternative

If you prefer Python for registration:

```python
# scripts/ml/register_model.py
import psycopg2
from datetime import datetime

def register_model(conn, model_config):
    """Register ML model in database"""
    with conn.cursor() as cur:
        cur.execute("""
            INSERT INTO ml_models (
                model_name, model_version, model_type, objective,
                target_variable, prediction_horizon, validation_score,
                test_score, tier_requirement, status
            ) VALUES (
                %(model_name)s, %(model_version)s, %(model_type)s, %(objective)s,
                %(target_variable)s, %(prediction_horizon)s, %(validation_score)s,
                %(test_score)s, %(tier_requirement)s, %(status)s
            )
            RETURNING model_id, model_name, model_version, status
        """, model_config)

        result = cur.fetchone()
        conn.commit()

        return {
            'model_id': result[0],
            'model_name': result[1],
            'model_version': result[2],
            'status': result[3]
        }

# Usage
if __name__ == '__main__':
    conn = psycopg2.connect(
        host='localhost',
        database='vfr_api',
        user='vfr_app_role',
        password='your_password'
    )

    config = {
        'model_name': 'sentiment-fusion',
        'model_version': 'v1.1.0',
        'model_type': 'lightgbm',
        'objective': 'direction_classification',
        'target_variable': 'price_direction_3d',
        'prediction_horizon': '1w',
        'validation_score': 0.5380,
        'test_score': 0.5250,
        'tier_requirement': 'premium',
        'status': 'deployed'
    }

    result = register_model(conn, config)
    print(f"✅ Registered {result['model_name']} v{result['model_version']}")
    print(f"   Model ID: {result['model_id']}")
    print(f"   Status: {result['status']}")

    conn.close()
```

---

## Verification Steps

### 1. Verify Directory Structure

```bash
# Check if model files exist
ls -la models/sentiment-fusion/v1.1.0/

# Expected output:
# -rw-r--r-- model.txt           (10-500MB)
# -rw-r--r-- normalizer.json     (1-10KB)
# -rw-r--r-- metadata.json       (1-5KB)
```

### 2. Verify File Permissions

```bash
# Files must be readable by application
chmod 644 models/sentiment-fusion/v1.1.0/*
```

### 3. Verify Database Registration

```sql
-- Check if model is registered
SELECT
    model_id,
    model_name,
    model_version,
    model_type,
    status,
    validation_score,
    created_at
FROM ml_models
WHERE model_name = 'sentiment-fusion'
  AND model_version = 'v1.1.0';

-- Expected: 1 row with status = 'deployed'
```

### 4. Verify Model Path Resolution

```typescript
// scripts/ml/test-model-loading.ts
import { ModelRegistry } from '../app/services/ml/models/ModelRegistry';
import * as path from 'path';
import * as fs from 'fs';

async function verifyModelPaths() {
  const registry = ModelRegistry.getInstance();
  await registry.initialize();

  const result = await registry.getDeployedModels();

  if (result.success && result.data) {
    for (const model of result.data) {
      const expectedPath = path.join(
        process.cwd(),
        `models/${model.modelName}/${model.modelVersion}/model.txt`
      );

      console.log(`Checking ${model.modelName} v${model.modelVersion}...`);
      console.log(`  Expected path: ${expectedPath}`);

      if (fs.existsSync(expectedPath)) {
        console.log('  ✅ Model file found');
      } else {
        console.log('  ❌ Model file NOT found');
      }

      const normalizerPath = path.join(
        process.cwd(),
        `models/${model.modelName}/${model.modelVersion}/normalizer.json`
      );

      if (fs.existsSync(normalizerPath)) {
        console.log('  ✅ Normalizer found');
      } else {
        console.log('  ❌ Normalizer NOT found');
      }
    }
  }
}

verifyModelPaths();
```

```bash
npx ts-node scripts/ml/test-model-loading.ts
```

### 5. Test Prediction

```bash
# Test prediction API with new model
curl -X POST http://localhost:3000/api/stocks/analyze \
  -H "Content-Type: application/json" \
  -d '{
    "symbols": ["AAPL"],
    "include_ml": true
  }'
```

**Expected Response:**
```json
{
  "success": true,
  "data": {
    "consensus": {
      "signal": "BULLISH",
      "confidence": 0.72,
      "score": 86
    },
    "votes": [
      {
        "modelName": "sentiment-fusion",
        "modelVersion": "v1.1.0",
        "signal": "BULLISH",
        "confidence": 0.78
      }
    ]
  }
}
```

---

## Common Issues

### Issue 1: "Model not found" Error

**Symptom:**
```
Error: Model not found: sentiment-fusion v1.1.0
```

**Cause:** Model not registered in database OR status not 'deployed'

**Fix:**
```sql
-- Check if model exists
SELECT * FROM ml_models
WHERE model_name = 'sentiment-fusion' AND model_version = 'v1.1.0';

-- If missing, run registration script
-- If exists but wrong status, update:
UPDATE ml_models
SET status = 'deployed'
WHERE model_name = 'sentiment-fusion' AND model_version = 'v1.1.0';
```

### Issue 2: "Failed to load model file"

**Symptom:**
```
Error: Failed to load model: models/sentiment-fusion/v1.1.0/model.txt not found
```

**Cause:** Directory structure incorrect or files missing

**Fix:**
```bash
# Verify directory structure
ls -la models/sentiment-fusion/v1.1.0/

# If missing, create directory and copy files
mkdir -p models/sentiment-fusion/v1.1.0
cp /path/to/model.txt models/sentiment-fusion/v1.1.0/
cp /path/to/normalizer.json models/sentiment-fusion/v1.1.0/
```

### Issue 3: Duplicate Key Violation

**Symptom:**
```
ERROR: duplicate key value violates unique constraint "ml_models_model_name_model_version_key"
```

**Cause:** Model already registered with same name + version

**Fix:**
```sql
-- Option 1: Update existing model
UPDATE ml_models
SET validation_score = 0.5380,
    test_score = 0.5250,
    status = 'deployed',
    updated_at = NOW()
WHERE model_name = 'sentiment-fusion' AND model_version = 'v1.1.0';

-- Option 2: Deprecate old, register new version
UPDATE ml_models
SET status = 'deprecated'
WHERE model_name = 'sentiment-fusion' AND model_version = 'v1.1.0';

-- Then register as v1.2.0 instead
```

### Issue 4: Normalizer Format Invalid

**Symptom:**
```
Error: Invalid normalizer format for feature 'sentiment_positive'
```

**Cause:** normalizer.json doesn't match expected schema

**Fix:**
```bash
# Validate JSON format
cat models/sentiment-fusion/v1.1.0/normalizer.json | python3 -m json.tool

# Expected format:
{
  "feature_name": {
    "mean": 0.0,
    "std": 1.0
  }
}
```

### Issue 5: All Models Return Same Confidence

**Symptom:** All 3 models show identical confidence (e.g., 41%)

**Cause:** Models loading from same file (path construction bug)

**Fix:**
```typescript
// Check RealTimePredictionEngine.ts line 999-1003
// Must be DYNAMIC path construction:
const modelPath = model.artifactPath ||
  path.join(process.cwd(), `models/${model.modelName}/${model.modelVersion}/model.txt`);

// NOT static:
const modelPath = path.join(process.cwd(), `models/sentiment-fusion/v1.1.0/model.txt`);
```

---

## Related Documentation

- **Model Loading Architecture:** `docs/ml/MODEL_LOADING_AND_ENSEMBLE_ARCHITECTURE.md`
- **Ensemble Voting System:** `docs/ml/MODEL_LOADING_AND_ENSEMBLE_ARCHITECTURE.md#ensemble-voting-system`
- **Model Registry API:** `app/services/ml/models/ModelRegistry.ts`
- **Database Schema:** `database/migrations/ml_phase1_schema_fixed.sql`

---

## Support

For additional help:
1. Check application logs: `logs/ml-predictions.log`
2. Review PostgreSQL logs: `/var/log/postgresql/`
3. Test model loading: `npx ts-node scripts/ml/test-model-loading.ts`
4. Consult ML team documentation: `docs/ml/CLAUDE.md`
